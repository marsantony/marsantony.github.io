<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <title>Twitch自動回覆</title>
</head>

<body>

    <label for="username">使用者帳號</label>
    <input type="text" id="username" />
    <br />
    <label for="password">OAuth密碼</label>
    <input type="password" id="password" />
    <br />

    <label for="azureFunctionKey">Azure Function Key</label>
    <input type="text" id="azureFunctionKey" />
    <br />


    <label for="gameName">自訂遊戲名稱</label>
    <input type="text" id="gameName" />

    <br />
    <input type="button" id="autoReply" value="開始自動回覆" />


    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>

    <script>
        var currentGameName = '';
        document.getElementById('autoReply').addEventListener('click', (e) => {
            const client = new tmi.Client({
                options: {
                    debug: false,
                    skipMembership: true, // 不接收 JOIN/PART 訊息
                    skipUpdatingEmotesets: true,
                },
                connection: {
                    reconnect: true,
                    secure: true
                },
                identity: {
                    username: document.getElementById('username').value,            // [TODO]: input your Twitch username
                    password: document.getElementById('password').value        // [TODO]: input the genereated oath password
                    // 1. go to https://twitchapps.com/tmi/
                    // 2. click "Connect"
                    // 3. You will get a password beginning with "oath..."
                    // 4. Copy the whole password and paste inside the 'genereated_oath_password'
                },
                channels: ['marsantonymars'] // [TODO]: input the channel name you want to listen to
            });

            client.connect().catch(console.error);

            client.on('message', (channel, tags, message, self) => {

                if (self || !message.startsWith('!')) return;

                const args = message.slice(1).split(' ');
                const command = args.shift().toLowerCase();
                //7C03DE1E0A68FCF5F6E5E0ED970FD0C3
                if (command === '遊戲') {
                    fetch(`https://getorangesteamstatus.azurewebsites.net/api/Get?code=${document.getElementById('azureFunctionKey').value}`)
                        .then((response) => {
                            console.log(response);
                            return response.json();
                        }).then((json) => {
                            console.log(json);
                            currentGameName = '';
                            currentGameName = json['response']['players'][0]['gameextrainfo'] || document.getElementById('gameName').value;

                            if (currentGameName)
                                client.say(channel, `自動回覆：「遊戲：${currentGameName}」`);
                        });
                }
            });
        }, { once: true });



    </script>
</body>

</html>